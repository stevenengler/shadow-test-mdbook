<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>OnionTrace - Shadow Simulator</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Shadow Network Simulator</li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Installation and Setup</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/supported_platforms.html"><strong aria-hidden="true">1.1.</strong> Supported Platforms</a></li><li class="chapter-item expanded "><a href="../shadow/install_dependencies.html"><strong aria-hidden="true">1.2.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="../shadow/install_shadow.html"><strong aria-hidden="true">1.3.</strong> Shadow</a></li><li class="chapter-item expanded "><a href="../shadow/system_configuration.html"><strong aria-hidden="true">1.4.</strong> System Configuration</a></li><li class="chapter-item expanded "><a href="../shadow/install_shadow_with_docker.html"><strong aria-hidden="true">1.5.</strong> (Experimental) Shadow with Docker</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> The Shadow Simulator</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/getting_started.html"><strong aria-hidden="true">2.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../shadow/parsing_statistics.html"><strong aria-hidden="true">2.2.</strong> Parsing Statistics</a></li><li class="chapter-item expanded "><a href="../shadow/log_format.html"><strong aria-hidden="true">2.3.</strong> Log Format</a></li><li class="chapter-item expanded "><a href="../shadow/design_overview.html"><strong aria-hidden="true">2.4.</strong> Design Overview</a></li><li class="chapter-item expanded "><a href="../shadow/notes_and_faq.html"><strong aria-hidden="true">2.5.</strong> Notes and FAQs</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Simulation Customization</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/shadow_config.html"><strong aria-hidden="true">3.1.</strong> Shadow Configuration</a></li><li class="chapter-item expanded "><a href="../shadow/network_config.html"><strong aria-hidden="true">3.2.</strong> Network Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/network_graph_attributes.html"><strong aria-hidden="true">3.2.1.</strong> Graph Configuration</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Developer Guides</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/developer_guide.html"><strong aria-hidden="true">4.1.</strong> Debugging and Profiling</a></li><li class="chapter-item expanded "><a href="../shadow/ci.html"><strong aria-hidden="true">4.2.</strong> Continous Integration Tests</a></li><li class="chapter-item expanded "><a href="../shadow/using_recompiled_libc.html"><strong aria-hidden="true">4.3.</strong> Using a Recompiled Libc</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> The Shadow Project</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/contributing.html"><strong aria-hidden="true">5.1.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/coding_style.html"><strong aria-hidden="true">5.1.1.</strong> Coding Style</a></li><li class="chapter-item expanded "><a href="../shadow/pull_requests.html"><strong aria-hidden="true">5.1.2.</strong> Pull Requests</a></li></ol></li><li class="chapter-item expanded "><a href="../shadow/maintainer_playbook.html"><strong aria-hidden="true">5.2.</strong> Maintainer Playbook</a></li><li class="chapter-item expanded "><a href="../shadow/nsf_sponsorship.html"><strong aria-hidden="true">5.3.</strong> NSF Sponsorship</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">TGen Traffic Generator</li><li class="chapter-item expanded "><a href="../tgen/index.html"><strong aria-hidden="true">6.</strong> About</a></li><li class="chapter-item expanded "><a href="../tgen/TGen-Markov-Models.html"><strong aria-hidden="true">7.</strong> Markov Models</a></li><li class="chapter-item expanded "><a href="../tgen/TGen-Options.html"><strong aria-hidden="true">8.</strong> Options</a></li><li class="chapter-item expanded "><a href="../tgen/TGen-Overview.html"><strong aria-hidden="true">9.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../tgen/Tools-JSON-Format.html"><strong aria-hidden="true">10.</strong> JSON Format</a></li><li class="chapter-item expanded affix "><li class="part-title">Tor Network Simulation</li><li class="chapter-item expanded "><a href="../tornettools/index.html"><strong aria-hidden="true">11.</strong> TorNetTools</a></li><li class="chapter-item expanded "><a href="../oniontrace/index.html" class="active"><strong aria-hidden="true">12.</strong> OnionTrace</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Shadow Simulator</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/shadow" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="oniontrace"><a class="header" href="#oniontrace">OnionTrace</a></h2>
<p><img src="https://github.com/shadow/oniontrace/workflows/Builds/badge.svg" alt="" /></p>
<p>This program records and plays back Tor circuit building and stream assignment.
It can also register for several asynchronous Tor events and logs the events
as they are received from Tor over time.</p>
<h2 id="setup"><a class="header" href="#setup">Setup</a></h2>
<p>Dependencies in Fedora/RedHat:</p>
<pre><code>sudo yum install cmake glib2 glib2-devel
</code></pre>
<p>Dependencies in Ubuntu/Debian:</p>
<pre><code>sudo apt-get install cmake libglib2.0-0 libglib2.0-dev
</code></pre>
<p>Build with a custom install prefix:</p>
<pre><code>mkdir build &amp;&amp; cd build
cmake .. -DCMAKE_INSTALL_PREFIX=/home/$USER/.local
make
</code></pre>
<p>Optionally install to the prefix:</p>
<pre><code>make install
</code></pre>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>oniontrace arguments should be configured as follows:
arguments=&quot;oniontrace key=value ...&quot;</p>
<p>The valid keys and the type of the valid values are listed below, along with
any defaults. The format is:<br />
+ <code>key</code>:ValueType (default=<code>val</code>) [Mode=<code>ValidMode</code>] - explanation</p>
<p>Specifying the run mode is <strong>optional</strong>, the default mode is <code>log</code>:</p>
<ul>
<li><code>Mode</code>:String (default=<code>log</code>) [Mode=<code>record</code>,<code>play</code>,<code>log</code>]<br />
Valid values for the running mode are <code>record</code>, <code>play</code>, and <code>log</code>.<br />
<code>record</code> mode records circuit creation and stream assignment schedules.<br />
<code>play</code> mode creates circuits and assigns streams according to a<br />
schedule as previously recorded with <code>record</code> mode.
<code>log</code> mode registers for async events and logs them to stdout as they occur.</li>
</ul>
<p>The following are <strong>required</strong> arguments (default values do not exist):</p>
<ul>
<li><code>TorControlPort</code>:Integer [Mode=<code>record</code>,<code>play</code>,<code>log</code>]<br />
The Tor Control server port, set in the torrc file of the Tor instance that<br />
you want to trace.</li>
</ul>
<p>The following are <strong>optional</strong> arguments (default values exist):</p>
<ul>
<li>
<p><code>LogLevel</code>:String (default=<code>info</code>) [Mode=<code>record</code>,<code>play</code>,<code>log</code>]<br />
The log level to use while running oniontrace. Valid values are:<br />
<code>debug</code> &gt; <code>info</code> &gt; <code>message</code> &gt; <code>warning</code><br />
Messages logged at a higher level than the one configured will be filtered.</p>
</li>
<li>
<p><code>TraceFile</code>:String (default=<code>oniontrace.csv</code>) [Mode=<code>record</code>,<code>play</code>]<br />
The filename to write the trace when in <code>record</code> mode, or read a previously<br />
recorded trace when in <code>play</code> mode.</p>
</li>
<li>
<p><code>RunTime</code>:Integer (default=<code>0</code>) [Mode=<code>record</code>,<code>play</code>]<br />
If positive, OnionTrace will stop running after the number of seconds<br />
specified in this value. In <code>record</code> mode, this has the effect of recording<br />
all circuits that are being tracked even if those circuits have not yet<br />
been closed by Tor.</p>
</li>
<li>
<p><code>Events</code>:String (default=<code>BW</code>) [Mode=<code>log</code>]<br />
The asynchronous Tor events for which we should listen and log when<br />
we receive them from Tor. The value string should be a comma-delimited list<br />
of events, e.g., 'BW,CIRC,STREAM'. See Section 4.1 of the<br />
'Tor control protocol' specification for a full list of acceptable events.<br />
(https://gitweb.torproject.org/torspec.git/tree/control-spec.txt)</p>
</li>
</ul>
<h2 id="tor-changes-required-for-record-mode"><a class="header" href="#tor-changes-required-for-record-mode">Tor Changes Required for record Mode</a></h2>
<p>In order for the <code>record</code> mode to work correctly, we need Tor to export the
socks username in all stream control events. That will allow us to keep the
the same streams on the correct circuits when using <code>playback</code> mode to play
back a recorded trace file.</p>
<p>If the original stream control event is this:</p>
<pre><code>650 STREAM 21 NEW 0 11.0.0.6:18080 SOURCE_ADDR=127.0.0.1:21437
</code></pre>
<p>We need to change Tor so that it outputs events like:</p>
<pre><code>650 STREAM 21 NEW 0 11.0.0.6:18080 SOURCE_ADDR=127.0.0.1:21437 USERNAME=MYUSER
</code></pre>
<p>Where <code>MYUSER</code> is the SOCKS username in use to tie that stream to a circuit.
Here is a patch that was created to do this for <code>tor-0.3.5.8</code>, which may help
you understand how to change a newer version of Tor to export the correct info.</p>
<pre><code>diff --git a/src/feature/control/control.c b/src/feature/control/control.c
index cc7ecff2f..fac51eb38 100644
--- a/src/feature/control/control.c
+++ b/src/feature/control/control.c
@@ -5904,16 +5904,28 @@ control_event_stream_status(entry_connection_t *conn, stream_status_event_t tp,
       purpose = &quot; PURPOSE=USER&quot;;
   }
 
+  /* send socks username along with stream events. */
+  char user[64];
+  int do_user = (conn-&gt;socks_request &amp;&amp; conn-&gt;socks_request-&gt;username) ? 1 : 0;
+
+  if(do_user) {
+    char* u_null_term = tor_memdup_nulterm(conn-&gt;socks_request-&gt;username,
+        conn-&gt;socks_request-&gt;usernamelen);
+    tor_snprintf(user, 64, &quot; USERNAME=%s&quot;, u_null_term);
+    free(u_null_term);
+  }
+
   circ = circuit_get_by_edge_conn(ENTRY_TO_EDGE_CONN(conn));
   if (circ &amp;&amp; CIRCUIT_IS_ORIGIN(circ))
     origin_circ = TO_ORIGIN_CIRCUIT(circ);
   send_control_event(EVENT_STREAM_STATUS,
-                        &quot;650 STREAM %&quot;PRIu64&quot; %s %lu %s%s%s%s\r\n&quot;,
+                        &quot;650 STREAM %&quot;PRIu64&quot; %s %lu %s%s%s%s%s\r\n&quot;,
                      (ENTRY_TO_CONN(conn)-&gt;global_identifier),
                      status,
                         origin_circ?
                            (unsigned long)origin_circ-&gt;global_identifier : 0ul,
-                        buf, reason_buf, addrport_buf, purpose);
+                        buf, reason_buf, addrport_buf, purpose,
+                        do_user ? user : &quot;&quot;);
 
   /* XXX need to specify its intended exit, etc? */
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../tornettools/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../tornettools/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
