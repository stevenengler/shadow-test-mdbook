<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using a Recompiled Libc - Shadow Simulator</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Shadow Network Simulator</li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.</strong> Installation and Setup</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/supported_platforms.html"><strong aria-hidden="true">1.1.</strong> Supported Platforms</a></li><li class="chapter-item expanded "><a href="../shadow/install_dependencies.html"><strong aria-hidden="true">1.2.</strong> Dependencies</a></li><li class="chapter-item expanded "><a href="../shadow/install_shadow.html"><strong aria-hidden="true">1.3.</strong> Shadow</a></li><li class="chapter-item expanded "><a href="../shadow/system_configuration.html"><strong aria-hidden="true">1.4.</strong> System Configuration</a></li><li class="chapter-item expanded "><a href="../shadow/install_shadow_with_docker.html"><strong aria-hidden="true">1.5.</strong> (Experimental) Shadow with Docker</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">2.</strong> The Shadow Simulator</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/getting_started.html"><strong aria-hidden="true">2.1.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../shadow/parsing_statistics.html"><strong aria-hidden="true">2.2.</strong> Parsing Statistics</a></li><li class="chapter-item expanded "><a href="../shadow/log_format.html"><strong aria-hidden="true">2.3.</strong> Log Format</a></li><li class="chapter-item expanded "><a href="../shadow/design_overview.html"><strong aria-hidden="true">2.4.</strong> Design Overview</a></li><li class="chapter-item expanded "><a href="../shadow/notes_and_faq.html"><strong aria-hidden="true">2.5.</strong> Notes and FAQs</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">3.</strong> Simulation Customization</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/shadow_config.html"><strong aria-hidden="true">3.1.</strong> Shadow Configuration</a></li><li class="chapter-item expanded "><a href="../shadow/network_config.html"><strong aria-hidden="true">3.2.</strong> Network Configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/network_graph_attributes.html"><strong aria-hidden="true">3.2.1.</strong> Graph Configuration</a></li></ol></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">4.</strong> Developer Guides</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/developer_guide.html"><strong aria-hidden="true">4.1.</strong> Debugging and Profiling</a></li><li class="chapter-item expanded "><a href="../shadow/ci.html"><strong aria-hidden="true">4.2.</strong> Continous Integration Tests</a></li><li class="chapter-item expanded "><a href="../shadow/using_recompiled_libc.html" class="active"><strong aria-hidden="true">4.3.</strong> Using a Recompiled Libc</a></li></ol></li><li class="chapter-item expanded "><div><strong aria-hidden="true">5.</strong> The Shadow Project</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/contributing.html"><strong aria-hidden="true">5.1.</strong> Contributing</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../shadow/coding_style.html"><strong aria-hidden="true">5.1.1.</strong> Coding Style</a></li><li class="chapter-item expanded "><a href="../shadow/pull_requests.html"><strong aria-hidden="true">5.1.2.</strong> Pull Requests</a></li></ol></li><li class="chapter-item expanded "><a href="../shadow/maintainer_playbook.html"><strong aria-hidden="true">5.2.</strong> Maintainer Playbook</a></li><li class="chapter-item expanded "><a href="../shadow/nsf_sponsorship.html"><strong aria-hidden="true">5.3.</strong> NSF Sponsorship</a></li></ol></li><li class="chapter-item expanded "><li class="part-title">TGen Traffic Generator</li><li class="chapter-item expanded "><a href="../tgen/index.html"><strong aria-hidden="true">6.</strong> About</a></li><li class="chapter-item expanded "><a href="../tgen/TGen-Markov-Models.html"><strong aria-hidden="true">7.</strong> Markov Models</a></li><li class="chapter-item expanded "><a href="../tgen/TGen-Options.html"><strong aria-hidden="true">8.</strong> Options</a></li><li class="chapter-item expanded "><a href="../tgen/TGen-Overview.html"><strong aria-hidden="true">9.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../tgen/Tools-JSON-Format.html"><strong aria-hidden="true">10.</strong> JSON Format</a></li><li class="chapter-item expanded affix "><li class="part-title">Tor Network Simulation</li><li class="chapter-item expanded "><a href="../tornettools/index.html"><strong aria-hidden="true">11.</strong> TorNetTools</a></li><li class="chapter-item expanded "><a href="../oniontrace/index.html"><strong aria-hidden="true">12.</strong> OnionTrace</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Shadow Simulator</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                        <a href="https://github.com/shadow" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                        
                        

                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="using-a-recompiled-libc"><a class="header" href="#using-a-recompiled-libc">Using a recompiled libc</a></h1>
<p>With a stock libc library, it's difficult to interpose every syscall via
<code>LD_PRELOAD</code>. Once code is executing inside a libc function such as <code>fwrite</code>,
it typically makes non-PLT calls and uses inline assembly to make system calls,
leaving no opportunity to intercept the system call itself via <code>LD_PRELOAD</code>.
For more about this problem see
<a href="https://www.jimnewsome.net/posts/interposing-internal-libc-calls/">https://www.jimnewsome.net/posts/interposing-internal-libc-calls/</a>.</p>
<p>One solution is to use <code>ptrace</code> instead, which can be done in shadow using
<code>--interpose-method=ptrace</code>. This approach can have some drawbacks though, such
as not being able to attach to the child process with gdb at runtime.</p>
<p>Another solution is to reimplement every entry point into libc, including
reimplementing e.g. <code>fwrite</code>, to ensure that they internally end up calling
Shadow's syscall implementation. For complete coverage of libc though, this
ends up requiring reimplementing a substantial chunk of the library. Shadow
does this for some of libc, but currently has some gaps, and probably always
will.</p>
<p>We can greatly improve our coverage of the libc API by patching a full
implementation of libc to make system calls via an interposable call to the
<code>syscall</code> function rather than using the <code>syscall</code> instruction inline. Then in
the Shadow shim we only need to interpose the <code>syscall</code> function.  For more
about how this works, and a proof of concept, see
<a href="https://www.jimnewsome.net/posts/patching-glibc-to-make-syscalls-interposable/">https://www.jimnewsome.net/posts/patching-glibc-to-make-syscalls-interposable/</a>.</p>
<p>For this to work reliably though, we have to be careful that our libc is
compatible with the system's libc headers. Therefore what we actually want to
do is patch the libc source from our system's package manager, and configure
and compile it with the same options that were used with the system's packaged
libc.</p>
<h2 id="compiling-on-ubuntu-1804"><a class="header" href="#compiling-on-ubuntu-1804">Compiling on Ubuntu 18.04</a></h2>
<ul>
<li>Enable source repos in <code>/etc/apt/sources.list</code></li>
<li>Run <code>apt source glibc-source</code> to get the system's glibc source.</li>
<li>Patch it (see below).</li>
<li>Run <code>dpkg-source --commit</code> to locally &quot;commit&quot; the patch.</li>
<li>Run <code>dpkg-buildpackage</code> to build the patched source along with Ubuntu's
additional patches and configuration options. For me this fails in testing,
but still produces the library binaries.</li>
</ul>
<p>To patch the source:</p>
<pre><code class="language-shell"># Save the source directory for future reference. Your version number may
# be different.
cd glibc-2.27
SYSTEM_LIBC_SOURCE=`pwd`

# Grab the patched glibc. This has to be outside of SYSTEM_LIBC_SOURCE.
cd ..
git clone https://github.com/sporksmith/glibc.git interposable-glibc
cd interposable-glibc

# Switch to the patched branch. interpose-syscalls-2.27 is based on 2.27.
# interpose-syscalls is baed on 2.31 (dev).
git checkout origin/interpose-syscalls-2.27

# Generate patches
git format-patch glibc-2.27

# Apply the patches
cd $SYSTEM_LIBC_SOURCE
patch -p1 ../interposable-glibc/*.patch
</code></pre>
<h2 id="compiling-on-centos-7"><a class="header" href="#compiling-on-centos-7">Compiling on CentOS 7</a></h2>
<p>Install prerequisites:</p>
<pre><code class="language-shell">sudo yum install -y \
    gcc \
    git \
    make \
    redhat-rpm-config \
    rpm-build
sudo yum-builddep -y glibc
</code></pre>
<p>Set up rpm build environment, following
<a href="https://wiki.centos.org/HowTos/SetupRpmBuildEnvironment">https://wiki.centos.org/HowTos/SetupRpmBuildEnvironment</a>:</p>
<pre><code class="language-shell">mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
echo '%_topdir %(echo $HOME)/rpmbuild' &gt; ~/.rpmmacros
</code></pre>
<p>Get and unpack centos7's glibc package:</p>
<pre><code class="language-shell">cd ~ &amp;&amp; yumdownloader --source glibc
cd ~ &amp;&amp; rpm -ivh glibc-2.17-307.el7.1.src.rpm
</code></pre>
<p>Get custom patched source, and use it to generate the patch:</p>
<pre><code class="language-shell">cd ~ &amp;&amp; git clone --depth=2 -b interpose-syscalls-2.17-centos7 https://github.com/sporksmith/glibc.git
cd ~/glibc &amp;&amp; git diff glibc-2.17-centos7 &gt; ~/rpmbuild/SOURCES/use-syscall-function.patch
</code></pre>
<p>Next you'll need to edit <code>~/rpmbuild/SPECS/glibc.spec</code> file to tell it to apply the patch.
You'll need to add a line like:</p>
<pre><code>PatchNNNN: use-syscall-function.patch
</code></pre>
<p>and another like:</p>
<pre><code>%patchNNNN -p1
</code></pre>
<p>For more on editing the spec file, see <a href="https://blog.packagecloud.io/eng/2015/04/20/working-with-source-rpms/#modifying-the-source-and-applying-patches">https://blog.packagecloud.io/eng/2015/04/20/working-with-source-rpms/#modifying-the-source-and-applying-patches</a>.</p>
<pre><code class="language-shell"># (Re)unpack, patch, and build
cd ~/rpmbuild/SPECS &amp;&amp; rpmbuild -ba glibc.spec
</code></pre>
<h2 id="using-the-compiled-libc"><a class="header" href="#using-the-compiled-libc">Using the compiled libc</a></h2>
<p>Our patched libc can be injected via <code>LD_LIBRARY_PATH</code> or <code>LD_PRELOAD</code>.
I've been using <code>LD_LIBRARY_PATH</code> because there are actually multiple libraries
compiled, and we'll want those others to be preferred as well (e.g. <code>libpthread</code>).
In shadow's configuration file you can set the environment variable for all
loaded plugins with the <code>environment</code> attribute of the <code>shadow</code> tag. e.g.:</p>
<pre><code>&lt;shadow environment=&quot;LD_LIBRARY_PATH=/path/to/glibc-2.27/build-tree/amd64-libc&quot;&gt;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../shadow/ci.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../shadow/contributing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../shadow/ci.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../shadow/contributing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
